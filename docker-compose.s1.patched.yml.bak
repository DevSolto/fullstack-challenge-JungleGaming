api-gateway:
  container_name: api-gateway
  build:
    context: .
    dockerfile: ./apps/api-gateway/Dockerfile
  working_dir: /app
  ports:
    - "3001:3001"
  environment:
    NODE_ENV: development
    PORT: 3001
    # watcher do Nest dentro de container (evita filewatch falhar)
    CHOKIDAR_USEPOLLING: "true"
  volumes:
    # monorepo montado
    - .:/app
    # cache da store do pnpm
    - pnpm_store:/root/.local/share/pnpm
    # node_modules “anônimos” para não poluir sua máquina
    - /app/node_modules
    - /app/apps/api-gateway/node_modules
  networks:
    - challenge-network
  depends_on:
    db:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
  # instala as deps do workspace e inicia Nest em watch
  command: >
    sh -lc "
      corepack enable &&
      pnpm -v &&
      pnpm -w install --frozen-lockfile=false &&
      pnpm -F @apps/api-gateway start:dev
    "
volumes:
  postgres_data:
  rabbitmq_data:
  pnpm_store:
